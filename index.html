<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Heartbeat Data Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> <!-- Add PapaParse for CSV parsing -->
    <style>
        .highcharts-figure,
        .highcharts-data-table table {
            min-width: 320px;
            max-width: 1000px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        /* Styling for the CSV iframe */
        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
        }

        .highcharts-tooltip {
            font-size: 20px;
        }

        .highcharts-area {
            fill-opacity: 0.3;
        }
    </style>
</head>
<body>
    <figure class="highcharts-figure">
        <div id="container"></div>
        <p class="highcharts-description">
            Chart showing heartbeats data updating every second.
        </p>
        <button id="exportButton">Export to Excel</button>
    </figure>

    <!-- Checkbox for heartbeat -->
    <input type="checkbox" id="HeartBeat"></input>

    <!-- Iframe for displaying CSV data -->
    <iframe id="csv-iframe"></iframe>

    <script>
        // Era Widget initialization
        const eraWidget = new EraWidget();
        let config = null;
        let heartbeatValue = 0; // Default heartbeat value
        const dataBuffer = [];

        eraWidget.onConfiguration((configuration) => {
            config = configuration.realtime_configs[0];
        });

        eraWidget.onValues((values) => {
            const input = document.getElementById('HeartBeat');
            heartbeatValue = values[config.id].value; // Get live heartbeat value
            input.checked = values[config.id].value > 0; // Update checkbox based on heartbeat
        });

        eraWidget.ready();

        // Highcharts function to update chart
        const onChartLoad = function () {
            const chart = this,
                series = chart.series[0];

            setInterval(function () {
                const x = (new Date()).getTime(), // Current time
                    y = heartbeatValue; // Live heartbeat value

                series.addPoint([x, y], true, true);
                dataBuffer.push([x, y]);

                // Limit the data buffer to 30 minutes (1800 seconds)
                const thirtyMinutesAgo = x - 1800 * 1000;
                while (dataBuffer.length > 0 && dataBuffer[0][0] < thirtyMinutesAgo) {
                    dataBuffer.shift();
                }
            }, 1000);
        };

        // Create initial data
        const data = (function () {
            const data = [];
            const time = (new Date().getTime());

            for (let i = -19; i <= 0; i += 1) {
                data.push({
                    x: time + i * 1000,
                    y: 0 // Default value for initial data
                });
            }
            return data;
        }());

        // Highcharts chart initialization
        Highcharts.chart('container', {
            chart: {
                type: 'areaspline',
                events: {
                    load: onChartLoad
                }
            },

            time: {
                useUTC: false
            },

            title: {
                text: 'Live Heartbeat Data'
            },

            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                maxPadding: 0.1
            },

            yAxis: {
                title: {
                    text: 'Heartbeat'
                },
                min: 0,
                max: 130,
                tickInterval: 10
            },

            tooltip: {
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}'
            },

            series: [{
                name: 'Heartbeats',
                data
            }]
        });

        // Export to Excel
        document.getElementById('exportButton').addEventListener('click', function () {
            const ws = XLSX.utils.json_to_sheet(dataBuffer.map(point => ({
                Time: (new Date(point[0])).toLocaleString(),
                Heartbeat: point[1]
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Heartbeats');
            XLSX.writeFile(wb, 'heartbeat_data.xlsx');
        });

        // Read and display CSV data
        const csvUrl = 'https://raw.githubusercontent.com/yourusername/yourrepo/main/weather_data.csv'; // Replace with actual CSV URL

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const iframe = document.getElementById('csv-iframe');
                const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                // Create a table from CSV data
                const table = document.createElement('table');
                const header = table.createTHead();
                const row = header.insertRow();

                // Table headers from CSV keys
                for (const key in results.data[0]) {
                    const cell = row.insertCell();
                    cell.textContent = key;
                }

                const tbody = table.createTBody();
                results.data.forEach(function(record) {
                    const row = tbody.insertRow();
                    for (const key in record) {
                        const cell = row.insertCell();
                        cell.textContent = record[key];
                    }
                });

                iframeDocument.body.appendChild(table);
            }
        });
    </script>
</body>
</html>
